const getPerCentOutMesQuery = "WITH egresos_por_mes AS ( SELECT EXTRACT(YEAR FROM fecha) AS anio, EXTRACT(MONTH FROM fecha) AS mes, COUNT(*) AS cantidad FROM egreso WHERE fecha < DATE_TRUNC('month', CURRENT_DATE) GROUP BY anio, mes ), egresos_mes_anterior AS ( SELECT EXTRACT(YEAR FROM fecha) AS anio, EXTRACT(MONTH FROM fecha) AS mes, COUNT(*) AS cantidad_anterior FROM egreso WHERE fecha BETWEEN DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1 month') AND DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1 day' GROUP BY anio, mes ) SELECT egresos_por_mes.anio, egresos_por_mes.mes, egresos_por_mes.cantidad, CASE WHEN egresos_mes_anterior.cantidad_anterior = 0 THEN null ELSE ROUND((egresos_por_mes.cantidad - egresos_mes_anterior.cantidad_anterior) * 100.0 / egresos_mes_anterior.cantidad_anterior, 2) END AS cambio_porcentaje FROM egresos_por_mes LEFT JOIN egresos_mes_anterior ON egresos_por_mes.anio = egresos_mes_anterior.anio AND egresos_por_mes.mes = egresos_mes_anterior.mes ORDER BY egresos_por_mes.anio, egresos_por_mes.mes;";
module.exports = { getPerCentOutMesQuery };