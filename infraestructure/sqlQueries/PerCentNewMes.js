const getPerCentNewMesQuery = "WITH benef_por_mes AS ( SELECT EXTRACT(YEAR FROM fecha_ingreso) AS anio, EXTRACT(MONTH FROM fecha_ingreso) AS mes, COUNT(*) FILTER (WHERE estado = true) AS nuevos FROM beneficiario GROUP BY anio, mes ), benef_anterior AS ( SELECT EXTRACT(YEAR FROM fecha_ingreso) AS anio, EXTRACT(MONTH FROM fecha_ingreso) AS mes, COUNT(*) FILTER (WHERE estado = true) AS nuevos_anterior FROM beneficiario WHERE fecha_ingreso < date_trunc('month', CURRENT_DATE - INTERVAL '1 month') AND estado = true GROUP BY anio, mes ) SELECT benef_por_mes.anio, benef_por_mes.mes, benef_por_mes.nuevos, ROUND(((benef_por_mes.nuevos::numeric - benef_anterior.nuevos_anterior::numeric) / benef_anterior.nuevos_anterior::numeric) * 100, 2) AS cambio_porcentaje FROM benef_por_mes LEFT JOIN benef_anterior ON benef_por_mes.anio = benef_anterior.anio AND benef_por_mes.mes = benef_anterior.mes ORDER BY benef_por_mes.anio, benef_por_mes.mes"

module.exports = { getPerCentNewMesQuery };